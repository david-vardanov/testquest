<%
  layout('layouts/boilerplate');
  const filterParams = Object.entries(filters).filter(([k,v]) => v).map(([k,v]) => `${k}=${encodeURIComponent(v)}`).join('&');
  const filterQuery = filterParams ? `?${filterParams}` : '';
%>

<style>
  .submission-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.8rem;
    background: white;
    transition: all 0.2s ease;
  }
  .submission-card:hover {
    border-color: #bdbdbd;
  }
  .submission-card.drag-over {
    border: 2px dashed #007bff;
    background: #e3f2fd;
    transform: scale(1.02);
  }
  .submission-card.dragging {
    opacity: 0.4;
    transform: scale(0.95);
  }
  .submission-header {
    background: #fafafa;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #e0e0e0;
    border-radius: 8px 8px 0 0;
  }
  .drag-handle {
    cursor: grab;
    padding: 0.2rem 0.35rem;
    color: #9e9e9e;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.15s ease;
    user-select: none;
    margin-right: 0.35rem;
    background: #f0f0f0;
    vertical-align: middle;
  }
  .drag-handle:hover {
    background: #e0e0e0;
    color: #424242;
  }
  .drag-handle:active {
    cursor: grabbing;
    background: #d0d0d0;
  }
  .submission-body {
    padding: 0.75rem;
  }
  .feedback-box {
    background: #fafafa;
    padding: 0.5rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    white-space: pre-wrap;
    font-size: 0.75rem;
    max-height: 100px;
    overflow-y: auto;
  }
  .screenshot-preview {
    max-width: 80px;
    max-height: 60px;
    border-radius: 4px;
    cursor: pointer;
  }
  .points-breakdown {
    background: #f5f5f5;
    padding: 0.5rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
  }
  .points-item {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
  }
  .points-item.rejected {
    text-decoration: line-through;
    opacity: 0.4;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }
  .status-dot.passed { background: #4caf50; }
  .status-dot.failed { background: #f44336; }
  .filter-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
  }
  .action-buttons {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
  }
  .action-buttons .btn {
    font-size: 0.65rem;
    padding: 0.2rem 0.4rem;
  }
  .badge {
    font-size: 0.7rem;
    font-weight: 500;
  }
  h6 {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #757575;
    margin-bottom: 0.5rem;
  }

  /* Admin notes */
  .admin-notes {
    background: #fff8e1;
    border: 1px dashed #ffb300;
    border-radius: 6px;
    padding: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.75rem;
  }
  .admin-notes-label {
    font-size: 0.65rem;
    color: #f57c00;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  .admin-notes-content {
    color: #5d4037;
    white-space: pre-wrap;
    cursor: pointer;
    min-height: 1.2em;
    padding: 0.2rem;
    border-radius: 3px;
    transition: background 0.15s ease;
  }
  .admin-notes-content:hover {
    background: rgba(255, 179, 0, 0.15);
  }
  .admin-notes-content.empty {
    color: #bdbdbd;
    font-style: italic;
  }
  .admin-notes-input {
    width: 100%;
    font-size: 0.75rem;
    color: #5d4037;
    border: 1px solid #ffb300;
    border-radius: 4px;
    padding: 0.3rem;
    background: white;
    resize: vertical;
    min-height: 50px;
    outline: none;
  }
  .admin-notes-input:focus {
    box-shadow: 0 0 0 2px rgba(255, 179, 0, 0.3);
  }

  /* Sort buttons */
  .sort-btn {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
  }
  .sort-btn.active {
    background-color: #495057;
    border-color: #495057;
    color: white;
  }

  /* Hidden submissions */
  .submission-item.hidden-by-admin {
    display: none;
  }
  .show-hidden .submission-item.hidden-by-admin {
    display: block;
  }
  .submission-item.hidden-by-admin .submission-card,
  .submission-item.hidden-by-admin .submission-group {
    opacity: 0.5;
    border-style: dashed;
  }
  .hide-btn {
    font-size: 0.65rem;
    padding: 0.1rem 0.3rem;
    opacity: 0.5;
    transition: opacity 0.15s;
  }
  .hide-btn:hover {
    opacity: 1;
  }
  .hidden-count-badge {
    background: #9e9e9e;
    color: white;
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    margin-left: 0.5rem;
  }
  /* Hidden cards inside groups */
  .submission-card.hidden-card {
    display: none;
  }
  .show-hidden .submission-card.hidden-card {
    display: block;
    opacity: 0.5;
    border-style: dashed;
  }

  /* Board hint */
  .board-hint {
    background: #fff3e0;
    border: 1px dashed #ff9800;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 0.7rem;
    color: #e65100;
  }

  /* Scroll indicator */
  .scroll-indicator {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .scroll-indicator.visible {
    opacity: 1;
  }
  .scroll-indicator.top {
    top: 15px;
  }
  .scroll-indicator.bottom {
    bottom: 15px;
  }
  .scroll-indicator .arrow {
    font-size: 1.1rem;
  }
  .scroll-indicator .countdown {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.1rem 0.5rem;
    border-radius: 10px;
    min-width: 1.5rem;
    text-align: center;
  }
  .scroll-indicator.scrolling {
    background: rgba(76, 175, 80, 0.9);
  }

  /* Custom confirm modal */
  .confirm-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  .confirm-modal-backdrop.visible {
    opacity: 1;
    visibility: visible;
  }
  .confirm-modal {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 360px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: scale(0.9) translateY(-20px);
    transition: transform 0.2s ease;
  }
  .confirm-modal-backdrop.visible .confirm-modal {
    transform: scale(1) translateY(0);
  }
  .confirm-modal-icon {
    width: 48px;
    height: 48px;
    background: #fff3e0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
  }
  .confirm-modal-title {
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 0.5rem;
    color: #333;
  }
  .confirm-modal-message {
    font-size: 0.9rem;
    text-align: center;
    color: #666;
    margin-bottom: 1.25rem;
    line-height: 1.4;
  }
  .confirm-modal-buttons {
    display: flex;
    gap: 0.75rem;
  }
  .confirm-modal-buttons button {
    flex: 1;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .confirm-modal-cancel {
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    color: #666;
  }
  .confirm-modal-cancel:hover {
    background: #eeeeee;
  }
  .confirm-modal-confirm {
    background: #ef5350;
    border: none;
    color: white;
  }
  .confirm-modal-confirm:hover {
    background: #e53935;
  }

  /* Masonry layout */
  #submissions-container {
    column-count: 3;
    column-gap: 1rem;
  }
  .submission-item {
    break-inside: avoid;
    margin-bottom: 0.75rem;
  }
  @media (max-width: 992px) {
    #submissions-container {
      column-count: 2;
    }
  }
  @media (max-width: 576px) {
    #submissions-container {
      column-count: 1;
    }
  }

  /* Chat Modal */
  .chat-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  .chat-modal-backdrop.visible {
    opacity: 1;
    visibility: visible;
  }
  .chat-modal {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: scale(0.9) translateY(-20px);
    transition: transform 0.2s ease;
  }
  .chat-modal-backdrop.visible .chat-modal {
    transform: scale(1) translateY(0);
  }
  .chat-modal-header {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    padding: 1rem 1.25rem;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chat-modal-header h5 {
    margin: 0;
    font-size: 1rem;
  }
  .chat-modal-body {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    max-height: 300px;
    min-height: 100px;
    background: #f8f9fa;
  }
  .chat-modal-body .message-bubble {
    max-width: 85%;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }
  .chat-modal-body .message-bubble.admin {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    margin-right: auto;
  }
  .chat-modal-body .message-bubble.user {
    background: #e9ecef;
    color: #333;
    margin-left: auto;
  }
  .chat-modal-body .message-time {
    font-size: 0.65rem;
    opacity: 0.7;
  }
  .chat-modal-footer {
    padding: 1rem;
    border-top: 1px solid #e9ecef;
  }
  .chat-empty {
    text-align: center;
    color: #6c757d;
    padding: 2rem;
  }
  .chat-case-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.8rem;
  }
  .chat-case-card .case-status {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .chat-case-card .case-status.passed {
    background: rgba(76, 175, 80, 0.3);
  }
  .chat-case-card .case-status.failed {
    background: rgba(244, 67, 54, 0.3);
  }
  .chat-case-card .case-section {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }
  .chat-case-card .case-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 0.15rem;
  }
  .message-screenshot {
    max-width: 100%;
    max-height: 150px;
    border-radius: 8px;
    margin-top: 0.25rem;
    cursor: pointer;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Revision de Envios</h2>
  <a href="/admin/submissions/export?<%= Object.entries(filters).filter(([k,v]) => v).map(([k,v]) => `${k}=${v}`).join('&') %>" class="btn btn-outline-secondary">
    Exportar CSV
  </a>
</div>

<div class="filter-card">
  <form method="GET" class="row g-3 align-items-end">
    <div class="col-md-2">
      <label class="form-label">Flujo</label>
      <select name="flow" class="form-select">
        <option value="">Todos los Flujos</option>
        <% flows.forEach(f => { %>
          <option value="<%= f._id %>" <%= filters.flow === f._id.toString() ? 'selected' : '' %>><%= f.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Estado</label>
      <select name="status" class="form-select">
        <option value="">Todos</option>
        <option value="passed" <%= filters.status === 'passed' ? 'selected' : '' %>>Aprobado</option>
        <option value="failed" <%= filters.status === 'failed' ? 'selected' : '' %>>Fallido</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Usuario</label>
      <select name="user" class="form-select">
        <option value="">Todos</option>
        <% users.forEach(u => { %>
          <option value="<%= u._id %>" <%= filters.user === u._id.toString() ? 'selected' : '' %>><%= u.username %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Grupo</label>
      <select name="group" class="form-select">
        <option value="">Todos</option>
        <% groups.forEach(g => { %>
          <option value="<%= g._id %>" <%= filters.group === g._id.toString() ? 'selected' : '' %>><%= g.code %> - <%= g.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Aprobacion</label>
      <select name="approved" class="form-select">
        <option value="">Todos</option>
        <option value="pending" <%= filters.approved === 'pending' ? 'selected' : '' %>>Pendiente</option>
        <option value="approved" <%= filters.approved === 'approved' ? 'selected' : '' %>>Aprobado</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </form>
  <div class="d-flex align-items-center justify-content-between mt-3 pt-3 border-top">
    <div class="d-flex align-items-center gap-2">
      <span class="text-muted" style="font-size: 0.8rem;">Ordenar:</span>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary sort-btn active" data-sort="date-desc" title="MÃ¡s reciente primero">
          ðŸ“… Reciente
        </button>
        <button type="button" class="btn btn-outline-secondary sort-btn" data-sort="date-asc" title="MÃ¡s antiguo primero">
          ðŸ“… Antiguo
        </button>
        <button type="button" class="btn btn-outline-secondary sort-btn" data-sort="name-asc" title="A-Z por usuario">
          Aâ†’Z
        </button>
        <button type="button" class="btn btn-outline-secondary sort-btn" data-sort="name-desc" title="Z-A por usuario">
          Zâ†’A
        </button>
        <button type="button" class="btn btn-outline-secondary sort-btn" data-sort="count-desc" title="Grupos con mÃ¡s envÃ­os primero">
          ðŸ“Š MÃ¡s envÃ­os
        </button>
        <button type="button" class="btn btn-outline-secondary sort-btn" data-sort="count-asc" title="Grupos con menos envÃ­os primero">
          ðŸ“Š Menos envÃ­os
        </button>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-check-label text-muted" style="font-size: 0.8rem;" for="showHiddenToggle">
        Mostrar ocultos
        <span id="hidden-count" class="hidden-count-badge" style="display: none;">0</span>
      </label>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="showHiddenToggle">
      </div>
    </div>
  </div>
</div>

<% if (submissions.length === 0) { %>
  <div class="text-center py-5">
    <div style="font-size: 3rem;">ðŸ“‹</div>
    <h5 class="mt-3">No se encontraron envios</h5>
    <p class="text-muted">Intenta ajustando tus filtros</p>
  </div>
<% } else { %>

<div class="board-hint">
  <strong>Tip:</strong> Arrastra el icono <span style="background:#f0f0f0;padding:2px 6px;border-radius:3px;">â‹®â‹®</span> para agrupar envios similares. Suelta una tarjeta sobre otra para crear un grupo.
</div>

<!-- Scroll indicators -->
<div id="scroll-indicator-top" class="scroll-indicator top">
  <span class="arrow">â†‘</span>
  <span>Scroll</span>
  <span class="countdown">3</span>
</div>
<div id="scroll-indicator-bottom" class="scroll-indicator bottom">
  <span class="arrow">â†“</span>
  <span>Scroll</span>
  <span class="countdown">3</span>
</div>

<!-- Custom confirm modal -->
<div id="confirm-modal" class="confirm-modal-backdrop">
  <div class="confirm-modal">
    <div class="confirm-modal-icon" id="confirm-modal-icon">ðŸ“¦</div>
    <div class="confirm-modal-title" id="confirm-modal-title">Confirmar</div>
    <div class="confirm-modal-message" id="confirm-modal-message">Â¿Estas seguro?</div>
    <div class="confirm-modal-buttons">
      <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Cancelar</button>
      <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Confirmar</button>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div id="chat-modal" class="chat-modal-backdrop">
  <div class="chat-modal">
    <div class="chat-modal-header">
      <div>
        <h5 class="mb-0">ðŸ’¬ <span id="chat-test-case">Caso</span></h5>
        <small style="opacity: 0.8;">con <span id="chat-user-name">Usuario</span></small>
      </div>
      <button type="button" class="btn-close btn-close-white" onclick="closeChatModal()"></button>
    </div>
    <div class="chat-modal-body" id="chat-messages">
      <div class="chat-empty">Cargando mensajes...</div>
    </div>
    <div class="chat-modal-footer">
      <form id="chat-form" enctype="multipart/form-data">
        <input type="hidden" id="chat-submission-id">
        <div class="d-flex gap-2 align-items-end">
          <div class="flex-grow-1">
            <input type="text" class="form-control" id="chat-input" placeholder="Escribe tu mensaje..." autocomplete="off">
          </div>
          <label class="btn btn-outline-secondary" title="Adjuntar imagen">
            <input type="file" id="chat-screenshot" accept="image/*" style="display: none;">
            ðŸ“Ž
          </label>
          <button type="submit" class="btn btn-success">Enviar</button>
        </div>
        <div id="chat-screenshot-preview" style="display: none; margin-top: 0.5rem;">
          <small class="text-muted">Imagen: <span id="chat-screenshot-name"></span></small>
          <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2" onclick="clearChatScreenshot()">âœ•</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="submissions-container">
  <% submissions.forEach(sub => { %>
    <div class="submission-item <%= sub.hiddenByAdmin ? 'hidden-by-admin' : '' %>"
         data-sort-date="<%= new Date(sub.createdAt).getTime() %>"
         data-sort-name="<%= (sub.user?.username || 'zzz').toLowerCase() %>"
         data-sort-count="1"
         data-hidden="<%= sub.hiddenByAdmin ? 'true' : 'false' %>">
      <div class="submission-card" data-submission-id="<%= sub._id %>">
        <div class="submission-header">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <span class="status-dot <%= sub.status %>"></span>
              <strong><%= sub.user ? sub.user.username : 'N/A' %></strong>
              <% if (sub.userGroupAtSubmission) { %>
                <span class="badge ms-1" style="background-color: <%= sub.userGroupAtSubmission.color %>; font-size: 0.65rem;">
                  <%= sub.userGroupAtSubmission.code %>
                </span>
              <% } %>
              <span class="text-muted">Â· <%= sub.createdAt.toLocaleDateString() %></span>
              <% if (!sub.pointsAwarded) { %>
                <span class="badge bg-warning text-dark ms-2">Pendiente</span>
              <% } %>
              <% if (sub.wasReassigned) { %>
                <span class="badge bg-info text-dark ms-1">Reasignado</span>
              <% } %>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-outline-secondary hide-btn"
                      data-submission-id="<%= sub._id %>"
                      title="<%= sub.hiddenByAdmin ? 'Mostrar' : 'Ocultar' %>">
                <%= sub.hiddenByAdmin ? 'ðŸ‘' : 'ðŸ‘â€ðŸ—¨' %>
              </button>
              <span class="text-muted"><%= sub.pointsEarned %> pts</span>
            </div>
          </div>
          <div class="mt-1">
            <small class="text-muted">
              <%= sub.flow ? sub.flow.name : 'N/A' %> â†’ <%= sub.testCase ? sub.testCase.title : 'N/A' %>
            </small>
            <% if (sub.testCase) { %>
              <a class="ms-2" style="font-size: 0.7rem; cursor: pointer;" data-bs-toggle="collapse" href="#testcase-<%= sub._id %>">Ver detalles</a>
            <% } %>
          </div>
          <% if (sub.testCase) { %>
            <div class="collapse mt-2" id="testcase-<%= sub._id %>">
              <div style="background: #f0f0f0; padding: 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                <div><strong>Objetivo:</strong> <%= sub.testCase.description %></div>
                <div class="mt-1"><strong>Pasos:</strong></div>
                <pre style="font-size: 0.7rem; margin: 0; white-space: pre-wrap;"><%= sub.testCase.scenario %></pre>
                <div class="mt-1"><strong>Esperado:</strong> <%= sub.testCase.expectedResult %></div>
              </div>
            </div>
          <% } %>
        </div>

        <div class="submission-body">
          <div class="row">
            <div class="col-8">
              <% if (sub.feedback) { %>
                <h6>Comentarios</h6>
                <div class="feedback-box"><%= sub.feedback %></div>
              <% } else { %>
                <div class="text-muted mb-3"><em>Sin comentarios proporcionados</em></div>
              <% } %>
              <% if (sub.screenshot) { %>
                <h6 class="mt-3">Captura de Pantalla</h6>
                <a href="/uploads/<%= sub.screenshot %>" target="_blank">
                  <img src="/uploads/<%= sub.screenshot %>" alt="Captura" class="screenshot-preview">
                </a>
              <% } %>
            </div>

            <div class="col-4">
              <h6>Puntos</h6>
              <div class="points-breakdown">
                <div class="points-item"><span>Base</span><span>1</span></div>
                <% if (sub.status === 'failed') { %>
                  <div class="points-item <%= sub.rejectedPoints && sub.rejectedPoints.bug ? 'rejected' : '' %>">
                    <span>Error</span>
                    <span class="d-flex align-items-center gap-1">
                      +3
                      <% if (!sub.pointsAwarded) { %>
                        <form method="POST" action="/admin/submissions/<%= sub._id %>/toggle/bug<%= filterQuery %>" class="d-inline">
                          <button type="submit" class="btn btn-link btn-sm p-0 <%= sub.rejectedPoints && sub.rejectedPoints.bug ? 'text-success' : 'text-danger' %>" style="font-size: 0.7rem;">
                            <%= sub.rejectedPoints && sub.rejectedPoints.bug ? 'âœ“' : 'âœ•' %>
                          </button>
                        </form>
                      <% } %>
                    </span>
                  </div>
                <% } %>
                <% if (sub.feedback && sub.feedback.trim()) { %>
                  <div class="points-item <%= sub.rejectedPoints && sub.rejectedPoints.feedback ? 'rejected' : '' %>">
                    <span>Comentarios</span>
                    <span class="d-flex align-items-center gap-1">
                      +1
                      <% if (!sub.pointsAwarded) { %>
                        <form method="POST" action="/admin/submissions/<%= sub._id %>/toggle/feedback<%= filterQuery %>" class="d-inline">
                          <button type="submit" class="btn btn-link btn-sm p-0 <%= sub.rejectedPoints && sub.rejectedPoints.feedback ? 'text-success' : 'text-danger' %>" style="font-size: 0.7rem;">
                            <%= sub.rejectedPoints && sub.rejectedPoints.feedback ? 'âœ“' : 'âœ•' %>
                          </button>
                        </form>
                      <% } %>
                    </span>
                  </div>
                <% } %>
                <% if (sub.screenshot) { %>
                  <div class="points-item <%= sub.rejectedPoints && sub.rejectedPoints.screenshot ? 'rejected' : '' %>">
                    <span>Captura</span>
                    <span class="d-flex align-items-center gap-1">
                      +1
                      <% if (!sub.pointsAwarded) { %>
                        <form method="POST" action="/admin/submissions/<%= sub._id %>/toggle/screenshot<%= filterQuery %>" class="d-inline">
                          <button type="submit" class="btn btn-link btn-sm p-0 <%= sub.rejectedPoints && sub.rejectedPoints.screenshot ? 'text-success' : 'text-danger' %>" style="font-size: 0.7rem;">
                            <%= sub.rejectedPoints && sub.rejectedPoints.screenshot ? 'âœ“' : 'âœ•' %>
                          </button>
                        </form>
                      <% } %>
                    </span>
                  </div>
                <% } %>
                <% if (sub.isUsefulFeedback) { %>
                  <div class="points-item"><span>Util</span><span>+1</span></div>
                <% } %>
                <div class="points-item" style="border-top: 1px solid #ddd; margin-top: 0.25rem; padding-top: 0.5rem;">
                  <strong>Total</strong>
                  <strong><%= sub.pointsEarned + (sub.isUsefulFeedback ? 1 : 0) %></strong>
                </div>
              </div>

              <div class="action-buttons">
                <button type="button" class="btn btn-outline-success btn-sm chat-btn"
                        data-user-id="<%= sub.user ? sub.user._id : '' %>"
                        data-user-name="<%= sub.user ? sub.user.username : 'N/A' %>"
                        data-submission-id="<%= sub._id %>"
                        data-test-case="<%= sub.testCase ? sub.testCase.title : '' %>"
                        title="Enviar mensaje">
                  ðŸ’¬
                </button>
                <% if (!sub.pointsAwarded) { %>
                  <form method="POST" action="/admin/submissions/<%= sub._id %>/approve<%= filterQuery %>" class="d-inline">
                    <button type="submit" class="btn btn-dark btn-sm">Aprobar</button>
                  </form>
                <% } %>
                <% if (sub.feedback && !sub.isUsefulFeedback && sub.pointsAwarded) { %>
                  <form method="POST" action="/admin/submissions/<%= sub._id %>/useful<%= filterQuery %>" class="d-inline">
                    <button type="submit" class="btn btn-outline-dark btn-sm">+1 Util</button>
                  </form>
                <% } %>
                <form method="POST" action="/admin/submissions/<%= sub._id %>/rerun<%= filterQuery %>" class="d-inline">
                  <button type="submit" class="btn btn-outline-secondary btn-sm" onclick="return confirm('Permitir repetir?')">Repetir</button>
                </form>
                <form method="POST" action="/admin/submissions/<%= sub._id %>/reset<%= filterQuery %>" class="d-inline">
                  <button type="submit" class="btn btn-outline-secondary btn-sm" onclick="return confirm('Eliminar y descontar puntos?')">Reiniciar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let draggedElement = null;
  let draggedId = null;

  // Sorting functionality
  const container = document.getElementById('submissions-container');
  const sortButtons = document.querySelectorAll('.sort-btn');

  function sortItems(sortType) {
    const items = Array.from(container.querySelectorAll('.submission-item'));

    items.sort((a, b) => {
      switch (sortType) {
        case 'date-desc':
          return parseInt(b.dataset.sortDate) - parseInt(a.dataset.sortDate);
        case 'date-asc':
          return parseInt(a.dataset.sortDate) - parseInt(b.dataset.sortDate);
        case 'name-asc':
          return a.dataset.sortName.localeCompare(b.dataset.sortName);
        case 'name-desc':
          return b.dataset.sortName.localeCompare(a.dataset.sortName);
        case 'count-desc':
          return parseInt(b.dataset.sortCount) - parseInt(a.dataset.sortCount);
        case 'count-asc':
          return parseInt(a.dataset.sortCount) - parseInt(b.dataset.sortCount);
        default:
          return 0;
      }
    });

    // Re-append items in sorted order
    items.forEach(item => container.appendChild(item));
  }

  sortButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update active state
      sortButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Sort items
      sortItems(this.dataset.sort);
    });
  });

  // Hide/Show functionality
  const showHiddenToggle = document.getElementById('showHiddenToggle');
  const hiddenCountBadge = document.getElementById('hidden-count');

  function updateHiddenCount() {
    const hiddenItems = document.querySelectorAll('.submission-item.hidden-by-admin, .submission-card.hidden-card').length;
    if (hiddenItems > 0) {
      hiddenCountBadge.textContent = hiddenItems;
      hiddenCountBadge.style.display = 'inline';
    } else {
      hiddenCountBadge.style.display = 'none';
    }
  }

  // Initial count
  updateHiddenCount();

  // Toggle show hidden
  if (showHiddenToggle && container) {
    showHiddenToggle.addEventListener('change', function() {
      container.classList.toggle('show-hidden', this.checked);
    });
  }

  // Hide button handler
  async function toggleHideSubmission(btn) {
    const submissionId = btn.dataset.submissionId;
    const card = btn.closest('.submission-card');
    const item = btn.closest('.submission-item');

    try {
      const response = await fetch(`/admin/submissions/${submissionId}/toggle-hidden`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        const data = await response.json();

        // Update button
        btn.innerHTML = data.hidden ? 'ðŸ‘' : 'ðŸ‘â€ðŸ—¨';
        btn.title = data.hidden ? 'Mostrar' : 'Ocultar';

        // Update classes
        if (card.dataset.inGroup === 'true') {
          card.classList.toggle('hidden-card', data.hidden);
          card.dataset.hidden = data.hidden ? 'true' : 'false';
        } else {
          item.classList.toggle('hidden-by-admin', data.hidden);
          item.dataset.hidden = data.hidden ? 'true' : 'false';
        }

        updateHiddenCount();
      } else {
        alert('Error al ocultar/mostrar');
      }
    } catch (err) {
      console.error('Hide error:', err);
      alert('Error al ocultar/mostrar');
    }
  }

  document.querySelectorAll('.hide-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const card = this.closest('.submission-card');
      const item = this.closest('.submission-item');
      const isCurrentlyHidden = card.dataset.hidden === 'true' || (item && item.dataset.hidden === 'true');
      const buttonRef = this;

      // Only confirm when hiding, not when showing
      if (!isCurrentlyHidden) {
        showConfirm({
          icon: 'ðŸ‘â€ðŸ—¨',
          title: 'Ocultar envÃ­o',
          message: 'Este envÃ­o se ocultara del panel. Puedes verlo activando "Mostrar ocultos".',
          confirmText: 'Ocultar',
          onConfirm: () => toggleHideSubmission(buttonRef)
        });
      } else {
        toggleHideSubmission(this);
      }
    });
  });

  // Auto-scroll variables
  let scrollInterval = null;
  let countdownInterval = null;
  let isAutoScrolling = false;
  let currentCountdown = 0;
  let currentScrollSpeed = 0;
  const SCROLL_ZONE = 120; // pixels from edge
  const SCROLL_SPEED_MIN = 3; // starting speed
  const SCROLL_SPEED_MAX = 25; // max speed
  const SCROLL_ACCELERATION = 0.5; // speed increase per frame

  const indicatorTop = document.getElementById('scroll-indicator-top');
  const indicatorBottom = document.getElementById('scroll-indicator-bottom');

  function showIndicator(direction, countdown) {
    const indicator = direction === 'up' ? indicatorTop : indicatorBottom;
    const otherIndicator = direction === 'up' ? indicatorBottom : indicatorTop;

    if (indicator) {
      indicator.classList.add('visible');
      indicator.classList.toggle('scrolling', countdown === 0);
      const countdownEl = indicator.querySelector('.countdown');
      if (countdownEl) {
        const scrollingText = direction === 'up' ? 'â†‘â†‘' : 'â†“â†“';
        countdownEl.textContent = countdown === 0 ? scrollingText : countdown;
      }
    }
    if (otherIndicator) {
      otherIndicator.classList.remove('visible', 'scrolling');
    }
  }

  function hideIndicators() {
    if (indicatorTop) indicatorTop.classList.remove('visible', 'scrolling');
    if (indicatorBottom) indicatorBottom.classList.remove('visible', 'scrolling');
  }

  function startCountdown(direction) {
    currentCountdown = 3;
    showIndicator(direction, currentCountdown);

    countdownInterval = setInterval(() => {
      currentCountdown--;
      if (currentCountdown > 0) {
        showIndicator(direction, currentCountdown);
      } else {
        clearInterval(countdownInterval);
        countdownInterval = null;
        startAutoScroll(direction);
      }
    }, 700); // 2.1 seconds total (3 steps x 700ms)
  }

  function startAutoScroll(direction) {
    if (isAutoScrolling) return;
    isAutoScrolling = true;
    currentScrollSpeed = SCROLL_SPEED_MIN;
    showIndicator(direction, 0);

    function doScroll() {
      if (!isAutoScrolling) return;

      // Accelerate up to max speed
      if (currentScrollSpeed < SCROLL_SPEED_MAX) {
        currentScrollSpeed = Math.min(currentScrollSpeed + SCROLL_ACCELERATION, SCROLL_SPEED_MAX);
      }

      window.scrollBy(0, direction === 'up' ? -currentScrollSpeed : currentScrollSpeed);
      requestAnimationFrame(doScroll);
    }
    doScroll();
  }

  function stopAutoScroll() {
    isAutoScrolling = false;
    currentScrollSpeed = 0;
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    if (scrollInterval) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
    hideIndicators();
  }

  // Handle drag start from drag handles only (cards only)
  document.querySelectorAll('.card-handle').forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      const card = this.closest('.submission-card');
      if (card) {
        card.setAttribute('draggable', 'true');
        draggedElement = card;
        draggedId = card.dataset.submissionId;
      }
    });
  });

  // Reset draggable on mouse up
  document.addEventListener('mouseup', function() {
    document.querySelectorAll('.submission-card').forEach(el => {
      el.setAttribute('draggable', 'false');
    });
  });

  // Drag start - set data
  document.addEventListener('dragstart', function(e) {
    if (draggedElement) {
      draggedElement.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedId);
    }
  });

  // Drag over - show drop target and handle auto-scroll
  let lastScrollZone = null;

  document.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    // Auto-scroll when near edges (only when dragging)
    if (draggedElement) {
      const y = e.clientY;
      const windowHeight = window.innerHeight;

      if (y < SCROLL_ZONE) {
        // Near top - prepare to scroll up
        if (lastScrollZone !== 'top') {
          stopAutoScroll();
          lastScrollZone = 'top';
          startCountdown('up');
        }
      } else if (y > windowHeight - SCROLL_ZONE) {
        // Near bottom - prepare to scroll down
        if (lastScrollZone !== 'bottom') {
          stopAutoScroll();
          lastScrollZone = 'bottom';
          startCountdown('down');
        }
      } else {
        // Not in scroll zone
        if (lastScrollZone !== null) {
          stopAutoScroll();
          lastScrollZone = null;
        }
      }
    }

    // Remove previous highlights
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

    const targetCard = e.target.closest('.submission-card');
    const targetGroup = e.target.closest('.submission-group');

    // Cards can drop on other cards or groups
    if (targetCard && targetCard !== draggedElement && !draggedElement.contains(targetCard)) {
      targetCard.classList.add('drag-over');
    } else if (targetGroup && !targetGroup.contains(draggedElement)) {
      targetGroup.classList.add('drag-over');
    }
  });

  // Drag leave
  document.addEventListener('dragleave', function(e) {
    const el = e.target.closest('.submission-card, .submission-group');
    if (el) el.classList.remove('drag-over');
  });

  // Drag end - cleanup
  document.addEventListener('dragend', function(e) {
    // Stop auto-scroll
    stopAutoScroll();
    lastScrollZone = null;

    document.querySelectorAll('.dragging, .drag-over').forEach(el => {
      el.classList.remove('dragging', 'drag-over');
    });
    document.querySelectorAll('.submission-card[draggable="true"]').forEach(el => {
      el.setAttribute('draggable', 'false');
    });
    draggedElement = null;
    draggedId = null;
  });

  // Drop - perform grouping
  document.addEventListener('drop', async function(e) {
    e.preventDefault();

    // Stop auto-scroll
    stopAutoScroll();
    lastScrollZone = null;

    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

    if (!draggedId || !draggedElement) {
      console.log('Drop: No dragged element');
      return;
    }

    const targetCard = e.target.closest('.submission-card');
    const targetGroup = e.target.closest('.submission-group');

    try {
      if (targetGroup && !targetGroup.contains(draggedElement)) {
        // Drop card onto existing group - add to group
        const response = await fetch(`/admin/submissions/group/${targetGroup.dataset.groupId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId: draggedId })
        });
        const data = await response.json();
        if (response.ok) location.reload();
        else alert('Error: ' + (data.error || 'Error al agregar al grupo'));
      } else if (targetCard && targetCard !== draggedElement) {
        const targetId = targetCard.dataset.submissionId;
        const targetGroupId = targetCard.dataset.groupId;

        if (targetGroupId) {
          // Target is in a group - add dragged card to that group
          const response = await fetch(`/admin/submissions/group/${targetGroupId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submissionId: draggedId })
          });
          const data = await response.json();
          if (response.ok) location.reload();
          else alert('Error: ' + (data.error || 'Error al agregar al grupo'));
        } else {
          // Create new group from two cards
          const response = await fetch('/admin/submissions/group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submissionIds: [draggedId, targetId] })
          });
          const data = await response.json();
          if (response.ok) location.reload();
          else alert('Error: ' + (data.error || 'Error al crear grupo'));
        }
      }
    } catch (err) {
      console.error('Drop error:', err);
      alert('Error al agrupar envios: ' + err.message);
    }
  });

  // Ungroup button handler
  document.querySelectorAll('.ungroup-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      const submissionId = this.dataset.submissionId;
      try {
        const response = await fetch(`/admin/submissions/${submissionId}/ungroup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) location.reload();
        else alert('Error al quitar del grupo');
      } catch (err) {
        console.error('Ungroup error:', err);
        alert('Error al quitar del grupo');
      }
    });
  });

  // Toggle collapsed state for grouped cards
  document.querySelectorAll('.submission-group .submission-card .submission-header').forEach(header => {
    header.addEventListener('click', function(e) {
      // Don't toggle if clicking on buttons or drag handle
      if (e.target.closest('.ungroup-btn') || e.target.closest('.drag-handle')) {
        return;
      }
      const card = this.closest('.submission-card');
      card.classList.toggle('expanded');
    });
  });

  // Editable group name
  function attachGroupNameEditor(nameEl) {
    nameEl.addEventListener('click', function(e) {
      e.stopPropagation();

      const groupId = this.dataset.groupId;
      const currentName = this.textContent.trim();
      const originalName = currentName === 'Grupo' ? '' : currentName;

      // Create input
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'group-name-input';
      input.value = originalName;
      input.placeholder = 'Nombre del grupo';

      // Replace span with input
      this.replaceWith(input);
      input.focus();
      input.select();

      let saved = false;

      // Save function
      const saveGroupName = async () => {
        if (saved) return;
        saved = true;

        const newName = input.value.trim();

        try {
          const response = await fetch(`/admin/submissions/group/${groupId}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
          });

          if (response.ok) {
            // Create new span with updated name
            const newSpan = document.createElement('span');
            newSpan.className = 'group-name';
            newSpan.dataset.groupId = groupId;
            newSpan.title = 'Clic para editar nombre';
            newSpan.textContent = newName || 'Grupo';
            input.replaceWith(newSpan);

            // Re-attach click handler
            attachGroupNameEditor(newSpan);
          } else {
            alert('Error al guardar nombre');
            location.reload();
          }
        } catch (err) {
          console.error('Rename error:', err);
          alert('Error al guardar nombre');
          location.reload();
        }
      };

      // Cancel function
      const cancelEdit = () => {
        if (saved) return;
        saved = true;

        const newSpan = document.createElement('span');
        newSpan.className = 'group-name';
        newSpan.dataset.groupId = groupId;
        newSpan.title = 'Clic para editar nombre';
        newSpan.textContent = originalName || 'Grupo';
        input.replaceWith(newSpan);
        attachGroupNameEditor(newSpan);
      };

      // Save on blur
      input.addEventListener('blur', saveGroupName);

      // Save on Enter, cancel on Escape
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    });
  }

  document.querySelectorAll('.group-name').forEach(attachGroupNameEditor);

  // Editable admin notes
  function attachAdminNotesEditor(notesEl) {
    notesEl.addEventListener('click', function(e) {
      e.stopPropagation();

      const submissionId = this.dataset.submissionId;
      const currentNotes = this.classList.contains('empty') ? '' : this.textContent.trim();

      // Create textarea
      const textarea = document.createElement('textarea');
      textarea.className = 'admin-notes-input';
      textarea.value = currentNotes;
      textarea.placeholder = 'Agregar nota del admin...';

      // Replace span with textarea
      this.replaceWith(textarea);
      textarea.focus();

      let saved = false;

      // Save function
      const saveNotes = async () => {
        if (saved) return;
        saved = true;

        const newNotes = textarea.value.trim();

        try {
          const response = await fetch(`/admin/submissions/${submissionId}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: newNotes })
          });

          if (response.ok) {
            // Create new span with updated notes
            const newSpan = document.createElement('div');
            newSpan.className = 'admin-notes-content' + (newNotes ? '' : ' empty');
            newSpan.dataset.submissionId = submissionId;
            newSpan.title = 'Clic para editar';
            newSpan.textContent = newNotes || 'Agregar nota...';
            textarea.replaceWith(newSpan);

            // Re-attach click handler
            attachAdminNotesEditor(newSpan);
          } else {
            alert('Error al guardar nota');
            location.reload();
          }
        } catch (err) {
          console.error('Save notes error:', err);
          alert('Error al guardar nota');
          location.reload();
        }
      };

      // Cancel function
      const cancelEdit = () => {
        if (saved) return;
        saved = true;

        const newSpan = document.createElement('div');
        newSpan.className = 'admin-notes-content' + (currentNotes ? '' : ' empty');
        newSpan.dataset.submissionId = submissionId;
        newSpan.title = 'Clic para editar';
        newSpan.textContent = currentNotes || 'Agregar nota...';
        textarea.replaceWith(newSpan);
        attachAdminNotesEditor(newSpan);
      };

      // Save on blur
      textarea.addEventListener('blur', saveNotes);

      // Save on Ctrl+Enter, cancel on Escape
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          this.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    });
  }

  document.querySelectorAll('.admin-notes-content').forEach(attachAdminNotesEditor);

  // Reusable confirm modal
  const confirmModal = document.getElementById('confirm-modal');
  const confirmModalIcon = document.getElementById('confirm-modal-icon');
  const confirmModalTitle = document.getElementById('confirm-modal-title');
  const confirmModalMessage = document.getElementById('confirm-modal-message');
  const confirmModalCancel = document.getElementById('confirm-modal-cancel');
  const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
  let confirmCallback = null;

  function showConfirm({ icon, title, message, confirmText, onConfirm }) {
    confirmModalIcon.textContent = icon || 'â“';
    confirmModalTitle.textContent = title || 'Confirmar';
    confirmModalMessage.textContent = message || 'Â¿Estas seguro?';
    confirmModalConfirm.textContent = confirmText || 'Confirmar';
    confirmCallback = onConfirm;
    confirmModal.classList.add('visible');
  }

  function hideConfirmModal() {
    confirmModal.classList.remove('visible');
    confirmCallback = null;
  }

  // Close modal on backdrop click
  confirmModal.addEventListener('click', function(e) {
    if (e.target === confirmModal) {
      hideConfirmModal();
    }
  });

  // Cancel button
  confirmModalCancel.addEventListener('click', hideConfirmModal);

  // Confirm button
  confirmModalConfirm.addEventListener('click', function() {
    if (confirmCallback) {
      confirmCallback();
    }
    hideConfirmModal();
  });

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && confirmModal.classList.contains('visible')) {
      hideConfirmModal();
    }
  });

  // Dissolve group button handler
  document.querySelectorAll('.dissolve-group-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const groupId = this.dataset.groupId;
      showConfirm({
        icon: 'ðŸ“¦',
        title: 'Disolver grupo',
        message: 'Los envios volveran a estar sin agrupar.',
        confirmText: 'Disolver',
        onConfirm: async () => {
          try {
            const response = await fetch(`/admin/submissions/group/${groupId}/dissolve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) location.reload();
            else alert('Error al disolver grupo');
          } catch (err) {
            console.error('Dissolve error:', err);
            alert('Error al disolver grupo');
          }
        }
      });
    });
  });

  // ===== CHAT MODAL =====
  const chatModal = document.getElementById('chat-modal');
  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatSubmissionId = document.getElementById('chat-submission-id');
  const chatUserName = document.getElementById('chat-user-name');
  const chatTestCase = document.getElementById('chat-test-case');

  // Open chat modal - now submission-based
  document.querySelectorAll('.chat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const submissionId = this.dataset.submissionId;
      const userName = this.dataset.userName;
      const testCase = this.dataset.testCase;

      if (!submissionId) {
        alert('Envio no encontrado');
        return;
      }

      chatSubmissionId.value = submissionId;
      chatUserName.textContent = userName;
      chatTestCase.textContent = testCase || 'Sin caso';

      chatModal.classList.add('visible');
      loadSubmissionChat(submissionId);
      chatInput.focus();
    });
  });

  // Close chat modal
  window.closeChatModal = function() {
    chatModal.classList.remove('visible');
    chatMessages.innerHTML = '<div class="chat-empty">Cargando mensajes...</div>';
  };

  // Close on backdrop click
  chatModal.addEventListener('click', function(e) {
    if (e.target === chatModal) {
      closeChatModal();
    }
  });

  // Close on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && chatModal.classList.contains('visible')) {
      closeChatModal();
    }
  });

  // Load chat messages for a specific submission
  async function loadSubmissionChat(submissionId) {
    try {
      const response = await fetch(`/admin/messages/submission/${submissionId}`);
      const data = await response.json();

      if (!data.success) {
        chatMessages.innerHTML = '<div class="chat-empty">Error al cargar mensajes</div>';
        return;
      }

      chatMessages.innerHTML = '';

      // Show case data card at the top
      if (data.submission && data.submission.testCase) {
        const tc = data.submission.testCase;
        const sub = data.submission;
        const caseCard = document.createElement('div');
        caseCard.className = 'chat-case-card';
        caseCard.innerHTML = `
          <div class="case-status ${sub.status}">${sub.status === 'passed' ? 'âœ“ Aprobado' : 'âœ— Fallido'}</div>
          <div><strong>${escapeHtml(tc.title)}</strong></div>
          ${tc.description ? `<div class="case-section"><div class="case-label">Objetivo</div><div>${escapeHtml(tc.description)}</div></div>` : ''}
          ${tc.scenario ? `<div class="case-section"><div class="case-label">Pasos</div><div style="white-space: pre-wrap;">${escapeHtml(tc.scenario)}</div></div>` : ''}
          ${tc.expectedResult ? `<div class="case-section"><div class="case-label">Resultado esperado</div><div>${escapeHtml(tc.expectedResult)}</div></div>` : ''}
          ${sub.feedback ? `<div class="case-section" style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem; margin-top: 0.75rem;"><div class="case-label">Comentario del usuario</div><div style="white-space: pre-wrap;">${escapeHtml(sub.feedback)}</div></div>` : ''}
          ${sub.screenshot ? `<div class="case-section"><div class="case-label">Captura del usuario</div><a href="/uploads/${sub.screenshot}" target="_blank"><img src="/uploads/${sub.screenshot}" style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-top: 0.25rem; border: 2px solid rgba(255,255,255,0.3);" alt="Captura"></a></div>` : ''}
        `;
        chatMessages.appendChild(caseCard);
      }

      // Show messages
      if (!data.messages || data.messages.length === 0) {
        const emptyNote = document.createElement('div');
        emptyNote.className = 'chat-empty';
        emptyNote.innerHTML = 'No hay mensajes. Inicia la conversacion!';
        chatMessages.appendChild(emptyNote);
      } else {
        data.messages.forEach(msg => {
          const bubble = document.createElement('div');
          bubble.className = `message-bubble ${msg.sender}`;
          bubble.style.display = 'flex';
          bubble.style.flexDirection = 'column';

          const time = new Date(msg.createdAt).toLocaleString('es', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
          });

          let html = '';
          if (msg.content) {
            html += `<div>${escapeHtml(msg.content)}</div>`;
          }
          if (msg.screenshot) {
            html += `<a href="/uploads/${msg.screenshot}" target="_blank"><img src="/uploads/${msg.screenshot}" class="message-screenshot" alt="Imagen"></a>`;
          }
          html += `<div class="message-time">${time}</div>`;

          bubble.innerHTML = html;
          chatMessages.appendChild(bubble);
        });
      }

      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      console.error('Load messages error:', err);
      chatMessages.innerHTML = '<div class="chat-empty">Error al cargar mensajes</div>';
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Screenshot handling for chat
  const chatScreenshotInput = document.getElementById('chat-screenshot');
  const chatScreenshotPreview = document.getElementById('chat-screenshot-preview');
  const chatScreenshotName = document.getElementById('chat-screenshot-name');

  chatScreenshotInput?.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      chatScreenshotName.textContent = this.files[0].name;
      chatScreenshotPreview.style.display = 'block';
    }
  });

  window.clearChatScreenshot = function() {
    chatScreenshotInput.value = '';
    chatScreenshotPreview.style.display = 'none';
  };

  // Send message - now submission-based
  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const content = chatInput.value.trim();
    const submissionId = chatSubmissionId.value;
    const file = chatScreenshotInput?.files[0];

    if ((!content && !file) || !submissionId) return;

    try {
      const formData = new FormData();
      if (content) formData.append('content', content);
      if (file) formData.append('screenshot', file);

      const response = await fetch(`/admin/messages/submission/${submissionId}`, {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        chatInput.value = '';
        clearChatScreenshot();

        // Remove empty state if present
        const emptyState = chatMessages.querySelector('.chat-empty');
        if (emptyState) emptyState.remove();

        // Add message to chat
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble admin';
        bubble.style.display = 'flex';
        bubble.style.flexDirection = 'column';

        const time = new Date().toLocaleString('es', {
          day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        let html = '';
        if (content) {
          html += `<div>${escapeHtml(content)}</div>`;
        }
        if (data.message.screenshot) {
          html += `<a href="/uploads/${data.message.screenshot}" target="_blank"><img src="/uploads/${data.message.screenshot}" class="message-screenshot" alt="Imagen"></a>`;
        }
        html += `<div class="message-time">${time}</div>`;

        bubble.innerHTML = html;
        chatMessages.appendChild(bubble);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } else {
        alert('Error al enviar mensaje: ' + (data.error || 'Error desconocido'));
      }
    } catch (err) {
      console.error('Send message error:', err);
      alert('Error al enviar mensaje');
    }
  });
});
</script>

<% } %>
