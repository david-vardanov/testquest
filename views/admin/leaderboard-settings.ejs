<% layout('layouts/boilerplate') %>

<div class="row">
  <div class="col-md-8">
    <h4>Current Leaderboard</h4>

    <% if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <% if (success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <table class="table table-sm">
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Points</th>
          <th>Reward</th>
        </tr>
      </thead>
      <tbody>
        <% for (var i = 0; i < users.length; i++) { %>
          <% var user = users[i]; %>
          <% var pos = i + 1; %>
          <% var userReward = null; %>
          <% for (var j = 0; j < rewards.length; j++) { %>
            <% if (!userReward && pos >= rewards[j].positionFrom && pos <= rewards[j].positionTo) userReward = rewards[j]; %>
          <% } %>
          <tr>
            <td><strong><%= pos %></strong></td>
            <td><%= user.username %></td>
            <td><%= user.points %></td>
            <td>
              <% if (userReward) { %>
                <span class="badge bg-success"><%= userReward.prizeDescription || userReward.name %></span>
              <% } else { %>
                <span class="text-muted">-</span>
              <% } %>
            </td>
          </tr>
        <% } %>
        <% if (users.length === 0) { %>
          <tr><td colspan="4" class="text-muted text-center">No users yet</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div class="col-md-4">
    <div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <div class="card-body">
        <h5>Season Settings</h5>
        <form method="POST" action="/admin/leaderboard/settings">
          <div class="mb-3">
            <label class="form-label" style="font-size: 0.85rem;">Season Name</label>
            <input type="text" name="name" class="form-control form-control-sm" value="<%= settings ? settings.name : 'Current Season' %>" required>
          </div>
          <div class="mb-3">
            <label class="form-label" style="font-size: 0.85rem;">End Date</label>
            <input type="date" name="endDate" class="form-control form-control-sm">
          </div>
          <button type="submit" class="btn btn-light btn-sm w-100">Save Settings</button>
        </form>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h6>Close Season</h6>
        <p class="text-muted" style="font-size: 0.8rem;">
          This will archive the current leaderboard and reset all user points to 0.
        </p>
        <form method="POST" action="/admin/leaderboard/close" onsubmit="return confirm('Are you sure? All points will be reset to 0.');">
          <button type="submit" class="btn btn-danger btn-sm w-100">Close Season & Reset Points</button>
        </form>
      </div>
    </div>

    <h6>Past Seasons</h6>
    <% if (archives.length > 0) { %>
      <% for (var k = 0; k < archives.length; k++) { %>
        <% var archive = archives[k]; %>
        <div class="mb-2 p-2 border-start border-primary border-3">
          <strong><%= archive.name %></strong>
          <div class="text-muted" style="font-size: 0.75rem;">
            <%= archive.leaderboard ? archive.leaderboard.length : 0 %> participants
          </div>
          <a href="/admin/leaderboard/archive/<%= archive._id %>" class="btn btn-outline-primary btn-sm mt-1">View</a>
        </div>
      <% } %>
    <% } else { %>
      <p class="text-muted" style="font-size: 0.85rem;">No archived seasons yet.</p>
    <% } %>
  </div>
</div>
