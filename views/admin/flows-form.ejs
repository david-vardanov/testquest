<% layout('layouts/boilerplate') %>

<style>
  .flow-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
  }
  .test-case-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    position: relative;
  }
  .test-case-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  }
  .test-case-card .card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    padding: 1rem 1.25rem;
  }
  .test-case-card .card-body {
    padding: 1.5rem;
  }
  .test-case-card.collapsed .card-body {
    display: none;
  }
  .test-case-card.reused {
    border-color: #28a745;
    background: #f8fff9;
  }
  .test-case-card.reused .card-header {
    background: #e8f5e9;
  }
  .case-number-badge {
    background: #667eea;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
  }
  .reused-badge {
    background: #28a745;
  }
  .add-case-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .add-case-btn {
    flex: 1;
    padding: 1rem;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
  .add-case-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
  }
  .add-case-btn i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    display: block;
  }
  .modal-body {
    max-height: 60vh;
    overflow-y: auto;
  }
  .existing-case-item {
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .existing-case-item:hover {
    background: #f8f9fa;
    border-color: #667eea;
  }
  .existing-case-item.selected {
    background: #e8f0ff;
    border-color: #667eea;
  }
  .collapse-icon {
    transition: transform 0.3s ease;
  }
  .collapsed .collapse-icon {
    transform: rotate(-90deg);
  }
  .drag-handle {
    cursor: grab;
    color: #adb5bd;
    padding: 0.25rem;
    margin-right: 0.5rem;
    font-size: 1.1rem;
    transition: color 0.2s ease;
  }
  .drag-handle:hover {
    color: #667eea;
  }
  .drag-handle:active {
    cursor: grabbing;
  }
  .test-case-card.dragging {
    opacity: 0.5;
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
  }
  .test-case-card.drag-over {
    border-color: #667eea;
    border-style: dashed;
    background: #f8f9ff;
  }
  .test-case-card.drag-over::before {
    content: '';
    position: absolute;
    top: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: #667eea;
    border-radius: 3px;
  }
  .empty-state {
    text-align: center;
    padding: 3rem;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px dashed #dee2e6;
  }
  .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
  }
  .form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
  }
</style>

<div class="flow-header">
  <h2 class="mb-0"><%= flow ? 'Editar' : 'Crear' %> Flujo de Prueba</h2>
  <p class="mb-0 mt-2 opacity-75">Construye tu flujo de prueba agregando o reutilizando casos de prueba</p>
</div>

<form method="POST" action="/admin/flows<%= flow ? '/' + flow._id : '' %>" id="flowForm">
  <div class="row">
    <div class="col-md-8">
      <!-- Flow Details -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nombre del Flujo</label>
                <input type="text" name="name" class="form-control" value="<%= flow ? flow.name : '' %>" required placeholder="ej., Pruebas de Autenticacion">
              </div>
            </div>
            <div class="col-md-2">
              <div class="mb-3">
                <label class="form-label">Orden</label>
                <input type="number" name="order" class="form-control" value="<%= flow ? (flow.order || 0) : 0 %>" min="0" placeholder="0">
                <small class="text-muted">Menor = primero</small>
              </div>
            </div>
            <div class="col-md-2">
              <div class="mb-3">
                <label class="form-label">Puntos</label>
                <div class="input-group">
                  <input type="number" name="points" class="form-control" value="<%= flow ? flow.points : 0 %>" min="0">
                  <span class="input-group-text">pts</span>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="mb-3">
                <label class="form-label">Bonus</label>
                <div class="input-group">
                  <input type="number" name="completionBonus" class="form-control" value="<%= flow ? flow.completionBonus : 3 %>" min="0">
                  <span class="input-group-text">pts</span>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripcion</label>
            <textarea name="description" class="form-control" rows="2" placeholder="Describe el objetivo de la prueba..."><%= flow ? flow.description : '' %></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Flujos Prerequisitos</label>
            <p class="text-muted small mb-2">Los usuarios deben completar estos flujos antes de acceder a este</p>
            <% if (typeof allFlows !== 'undefined' && allFlows.length > 0) { %>
              <select name="prerequisiteFlows" class="form-select" multiple size="4">
                <% allFlows.forEach(f => { %>
                  <% const isSelected = flow && flow.prerequisiteFlows && flow.prerequisiteFlows.some(p => p._id.toString() === f._id.toString()); %>
                  <option value="<%= f._id %>" <%= isSelected ? 'selected' : '' %>><%= f.name %></option>
                <% }) %>
              </select>
              <small class="text-muted">Mant√©n presionado Ctrl/Cmd para seleccionar multiples</small>
            <% } else { %>
              <p class="text-muted small"><em>No hay otros flujos disponibles para usar como prerequisitos</em></p>
            <% } %>
          </div>
          <div class="form-check">
            <input type="checkbox" name="isActive" class="form-check-input" id="isActive" <%= (!flow || flow.isActive) ? 'checked' : '' %>>
            <label class="form-check-label" for="isActive">Activo (visible para testers)</label>
          </div>
        </div>
      </div>

      <!-- Test Cases Section -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Casos de Prueba</h5>
        <span class="badge bg-secondary" id="caseCount">0 casos</span>
      </div>

      <div class="add-case-buttons">
        <button type="button" class="add-case-btn" onclick="addNewTestCase()">
          <span style="font-size: 1.5rem;">‚úèÔ∏è</span>
          <div><strong>Crear Nuevo</strong></div>
          <small class="text-muted">Escribe un nuevo caso de prueba</small>
        </button>
        <button type="button" class="add-case-btn" onclick="showReuseCaseModal()">
          <span style="font-size: 1.5rem;">üìã</span>
          <div><strong>Reutilizar Existente</strong></div>
          <small class="text-muted">Selecciona de la biblioteca</small>
        </button>
      </div>

      <div id="testCasesContainer">
        <% if (flow && flow.testCases && flow.testCases.length > 0) { %>
          <% flow.testCases.forEach((tc, index) => { %>
            <div class="card test-case-card" data-case-id="<%= tc._id %>" draggable="true">
              <div class="card-header d-flex justify-content-between align-items-center" onclick="toggleCollapse(this)">
                <div class="d-flex align-items-center gap-2">
                  <span class="drag-handle" onclick="event.stopPropagation()" title="Arrastra para reordenar">‚ãÆ‚ãÆ</span>
                  <span class="case-number-badge"><%= index + 1 %></span>
                  <strong class="case-title"><%= tc.title %></strong>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="collapse-icon">‚ñº</span>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); removeTestCase(this)">‚úï</button>
                </div>
              </div>
              <div class="card-body">
                <input type="hidden" name="testCases[<%= index %>][id]" value="<%= tc._id %>">
                <input type="hidden" name="testCases[<%= index %>][isReused]" value="false">
                <div class="mb-3">
                  <label class="form-label">Titulo</label>
                  <input type="text" name="testCases[<%= index %>][title]" class="form-control case-title-input" value="<%= tc.title %>" required placeholder="ej., Registro de Usuario / Inicio de Sesion">
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Objetivo</label>
                      <textarea name="testCases[<%= index %>][description]" class="form-control" rows="3" required placeholder="Que debe verificar esta prueba?"><%= tc.description %></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Resultado Esperado</label>
                      <textarea name="testCases[<%= index %>][expectedResult]" class="form-control" rows="3" required placeholder="Que deberia pasar cuando la prueba pasa?"><%= tc.expectedResult %></textarea>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Pasos</label>
                  <textarea name="testCases[<%= index %>][scenario]" class="form-control" rows="5" required placeholder="1. Abrir app&#10;2. Navegar a...&#10;3. Verificar que..."><%= tc.scenario %></textarea>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <label class="form-label">Puntos</label>
                    <input type="number" name="testCases[<%= index %>][points]" class="form-control" value="<%= tc.points || 1 %>" min="1">
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <div id="emptyState" class="empty-state" style="<%= flow && flow.testCases && flow.testCases.length > 0 ? 'display:none' : '' %>">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
        <h5>Aun no hay casos de prueba</h5>
        <p class="text-muted">Crea un nuevo caso de prueba o reutiliza uno existente para comenzar</p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card sticky-top" style="top: 1rem;">
        <div class="card-body">
          <h6 class="mb-3">Resumen del Flujo</h6>
          <div class="mb-3">
            <small class="text-muted">Casos de Prueba</small>
            <div class="fs-4 fw-bold" id="summaryCount">0</div>
          </div>
          <div class="mb-3">
            <small class="text-muted">Puntos Base Totales</small>
            <div class="fs-4 fw-bold" id="summaryPoints">0</div>
          </div>
          <div class="mb-4">
            <small class="text-muted">Bonus de Completado</small>
            <div class="fs-4 fw-bold text-success">+<span id="summaryBonus"><%= flow ? flow.completionBonus : 3 %></span></div>
          </div>
          <hr>
          <button type="submit" class="btn btn-primary btn-lg w-100 mb-2">Guardar Flujo</button>
          <a href="/admin/flows" class="btn btn-outline-secondary w-100">Cancelar</a>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Reuse Case Modal -->
<div class="modal fade" id="reuseCaseModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Caso de Prueba para Reutilizar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="searchCases" placeholder="Buscar casos de prueba..." oninput="filterCases()">
        <div id="existingCasesList">
          <% if (typeof allTestCases !== 'undefined' && allTestCases.length > 0) { %>
            <% allTestCases.forEach(tc => { %>
              <div class="existing-case-item" data-id="<%= tc._id %>" data-title="<%= tc.title %>" data-description="<%= tc.description %>" data-scenario="<%= tc.scenario %>" data-expected="<%= tc.expectedResult %>" data-points="<%= tc.points %>" onclick="selectExistingCase(this)">
                <strong><%= tc.title %></strong>
                <div class="text-muted small"><%= tc.description ? tc.description.substring(0, 100) : '' %>...</div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="text-center text-muted py-4">No hay casos de prueba existentes disponibles</div>
          <% } %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="addSelectedCase()" id="addSelectedBtn" disabled>Agregar Seleccionado</button>
      </div>
    </div>
  </div>
</div>

<!-- New Case Template -->
<template id="newCaseTemplate">
  <div class="card test-case-card" draggable="true">
    <div class="card-header d-flex justify-content-between align-items-center" onclick="toggleCollapse(this)">
      <div class="d-flex align-items-center gap-2">
        <span class="drag-handle" onclick="event.stopPropagation()" title="Arrastra para reordenar">‚ãÆ‚ãÆ</span>
        <span class="case-number-badge">1</span>
        <strong class="case-title">Nuevo Caso de Prueba</strong>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="collapse-icon">‚ñº</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); removeTestCase(this)">‚úï</button>
      </div>
    </div>
    <div class="card-body">
      <input type="hidden" name="testCases[INDEX][isReused]" value="false">
      <div class="mb-3">
        <label class="form-label">Titulo</label>
        <input type="text" name="testCases[INDEX][title]" class="form-control case-title-input" required placeholder="ej., Registro de Usuario / Inicio de Sesion" oninput="updateCardTitle(this)">
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Objetivo</label>
            <textarea name="testCases[INDEX][description]" class="form-control" rows="3" required placeholder="Que debe verificar esta prueba?"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Resultado Esperado</label>
            <textarea name="testCases[INDEX][expectedResult]" class="form-control" rows="3" required placeholder="Que deberia pasar cuando la prueba pasa?"></textarea>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Pasos</label>
        <textarea name="testCases[INDEX][scenario]" class="form-control" rows="5" required placeholder="1. Abrir app&#10;2. Navegar a...&#10;3. Verificar que..."></textarea>
      </div>
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Puntos</label>
          <input type="number" name="testCases[INDEX][points]" class="form-control" value="1" min="1" onchange="updateSummary()">
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Reused Case Template -->
<template id="reusedCaseTemplate">
  <div class="card test-case-card reused" draggable="true">
    <div class="card-header d-flex justify-content-between align-items-center" onclick="toggleCollapse(this)">
      <div class="d-flex align-items-center gap-2">
        <span class="drag-handle" onclick="event.stopPropagation()" title="Arrastra para reordenar">‚ãÆ‚ãÆ</span>
        <span class="case-number-badge reused-badge">1</span>
        <strong class="case-title">Caso Reutilizado</strong>
        <span class="badge bg-success">Reutilizado</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="collapse-icon">‚ñº</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); removeTestCase(this)">‚úï</button>
      </div>
    </div>
    <div class="card-body">
      <input type="hidden" name="testCases[INDEX][reusedId]" value="">
      <input type="hidden" name="testCases[INDEX][isReused]" value="true">
      <input type="hidden" name="testCases[INDEX][title]" value="">
      <input type="hidden" name="testCases[INDEX][description]" value="">
      <input type="hidden" name="testCases[INDEX][scenario]" value="">
      <input type="hidden" name="testCases[INDEX][expectedResult]" value="">
      <input type="hidden" name="testCases[INDEX][points]" value="1">
      <div class="mb-2"><strong>Objetivo:</strong> <span class="reused-description"></span></div>
      <div class="mb-2"><strong>Pasos:</strong></div>
      <pre class="bg-light p-2 rounded reused-scenario" style="white-space: pre-wrap; font-size: 0.85rem;"></pre>
      <div><strong>Esperado:</strong> <span class="reused-expected"></span></div>
    </div>
  </div>
</template>

<script>
let testCaseIndex = <%= flow && flow.testCases ? flow.testCases.length : 0 %>;
let selectedCase = null;
let draggedCard = null;

// Drag and Drop functionality
function initDragAndDrop() {
  const container = document.getElementById('testCasesContainer');

  container.addEventListener('dragstart', (e) => {
    const card = e.target.closest('.test-case-card');
    if (!card) return;

    draggedCard = card;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', card.outerHTML);
  });

  container.addEventListener('dragend', (e) => {
    const card = e.target.closest('.test-case-card');
    if (card) {
      card.classList.remove('dragging');
    }
    draggedCard = null;
    document.querySelectorAll('.test-case-card').forEach(c => c.classList.remove('drag-over'));
  });

  container.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    const card = e.target.closest('.test-case-card');
    if (!card || card === draggedCard) return;

    document.querySelectorAll('.test-case-card').forEach(c => c.classList.remove('drag-over'));
    card.classList.add('drag-over');
  });

  container.addEventListener('dragleave', (e) => {
    const card = e.target.closest('.test-case-card');
    if (card) {
      card.classList.remove('drag-over');
    }
  });

  container.addEventListener('drop', (e) => {
    e.preventDefault();

    const targetCard = e.target.closest('.test-case-card');
    if (!targetCard || !draggedCard || targetCard === draggedCard) return;

    const cards = [...container.querySelectorAll('.test-case-card')];
    const draggedIndex = cards.indexOf(draggedCard);
    const targetIndex = cards.indexOf(targetCard);

    if (draggedIndex < targetIndex) {
      targetCard.parentNode.insertBefore(draggedCard, targetCard.nextSibling);
    } else {
      targetCard.parentNode.insertBefore(draggedCard, targetCard);
    }

    targetCard.classList.remove('drag-over');
    updateCaseNumbers();
    updateSummary();
  });
}

// Initialize drag and drop on page load
document.addEventListener('DOMContentLoaded', initDragAndDrop);

function addNewTestCase() {
  const container = document.getElementById('testCasesContainer');
  const template = document.getElementById('newCaseTemplate');
  const clone = template.content.cloneNode(true);

  clone.querySelectorAll('[name*="INDEX"]').forEach(el => {
    el.name = el.name.replace('INDEX', testCaseIndex);
  });

  container.appendChild(clone);
  testCaseIndex++;
  updateCaseNumbers();
  updateSummary();
  document.getElementById('emptyState').style.display = 'none';
}

function showReuseCaseModal() {
  selectedCase = null;
  document.querySelectorAll('.existing-case-item').forEach(el => el.classList.remove('selected'));
  document.getElementById('addSelectedBtn').disabled = true;
  new bootstrap.Modal(document.getElementById('reuseCaseModal')).show();
}

function selectExistingCase(el) {
  document.querySelectorAll('.existing-case-item').forEach(item => item.classList.remove('selected'));
  el.classList.add('selected');
  selectedCase = {
    id: el.dataset.id,
    title: el.dataset.title,
    description: el.dataset.description,
    scenario: el.dataset.scenario,
    expected: el.dataset.expected,
    points: el.dataset.points
  };
  document.getElementById('addSelectedBtn').disabled = false;
}

function addSelectedCase() {
  if (!selectedCase) return;

  const container = document.getElementById('testCasesContainer');
  const template = document.getElementById('reusedCaseTemplate');
  const clone = template.content.cloneNode(true);

  clone.querySelectorAll('[name*="INDEX"]').forEach(el => {
    el.name = el.name.replace('INDEX', testCaseIndex);
  });

  const card = clone.querySelector('.test-case-card');
  card.querySelector('.case-title').textContent = selectedCase.title;
  card.querySelector('[name$="[reusedId]"]').value = selectedCase.id;
  card.querySelector('[name$="[title]"]').value = selectedCase.title;
  card.querySelector('[name$="[description]"]').value = selectedCase.description;
  card.querySelector('[name$="[scenario]"]').value = selectedCase.scenario;
  card.querySelector('[name$="[expectedResult]"]').value = selectedCase.expected;
  card.querySelector('[name$="[points]"]').value = selectedCase.points;
  card.querySelector('.reused-description').textContent = selectedCase.description;
  card.querySelector('.reused-scenario').textContent = selectedCase.scenario;
  card.querySelector('.reused-expected').textContent = selectedCase.expected;

  container.appendChild(clone);
  testCaseIndex++;
  updateCaseNumbers();
  updateSummary();
  document.getElementById('emptyState').style.display = 'none';

  bootstrap.Modal.getInstance(document.getElementById('reuseCaseModal')).hide();
}

function filterCases() {
  const search = document.getElementById('searchCases').value.toLowerCase();
  document.querySelectorAll('.existing-case-item').forEach(item => {
    const title = item.dataset.title.toLowerCase();
    item.style.display = title.includes(search) ? '' : 'none';
  });
}

function removeTestCase(btn) {
  btn.closest('.test-case-card').remove();
  updateCaseNumbers();
  updateSummary();
  if (document.querySelectorAll('.test-case-card').length === 0) {
    document.getElementById('emptyState').style.display = '';
  }
}

function toggleCollapse(header) {
  header.closest('.test-case-card').classList.toggle('collapsed');
}

function updateCardTitle(input) {
  const card = input.closest('.test-case-card');
  const titleEl = card.querySelector('.case-title');
  titleEl.textContent = input.value || 'Nuevo Caso de Prueba';
}

function updateCaseNumbers() {
  const cards = document.querySelectorAll('.test-case-card');
  cards.forEach((card, idx) => {
    card.querySelector('.case-number-badge').textContent = idx + 1;
    card.querySelectorAll('[name^="testCases["]').forEach(el => {
      el.name = el.name.replace(/testCases\[\d+\]/, `testCases[${idx}]`);
    });
  });
  testCaseIndex = cards.length;
  document.getElementById('caseCount').textContent = cards.length + ' caso' + (cards.length !== 1 ? 's' : '');
}

function updateSummary() {
  const cards = document.querySelectorAll('.test-case-card');
  let totalPoints = 0;
  cards.forEach(card => {
    const pointsInput = card.querySelector('[name$="[points]"]');
    totalPoints += parseInt(pointsInput?.value || 1);
  });
  document.getElementById('summaryCount').textContent = cards.length;
  document.getElementById('summaryPoints').textContent = totalPoints;
}

// Update bonus display when changed
document.querySelector('[name="completionBonus"]')?.addEventListener('input', function() {
  document.getElementById('summaryBonus').textContent = this.value;
});

// Initial summary update
updateSummary();
updateCaseNumbers();
</script>
