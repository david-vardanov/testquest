<% layout('layouts/boilerplate') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Respaldos de Base de Datos</h2>
  <div>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
      Subir y Restaurar
    </button>
    <form method="POST" action="/admin/backups" class="d-inline">
      <button type="submit" class="btn btn-success" onclick="this.disabled=true; this.innerHTML='Creando respaldo...'; this.form.submit();">
        Crear Nuevo Respaldo
      </button>
    </form>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Subir y Restaurar Respaldo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/admin/backups/restore" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Advertencia:</strong> Esto reemplazara TODOS los datos actuales con los datos del respaldo. Esta accion no se puede deshacer.
          </div>
          <div class="mb-3">
            <label class="form-label">Seleccionar archivo de respaldo (.gz)</label>
            <input type="file" name="backup" class="form-control" accept=".gz" required>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="confirmRestore" required>
            <label class="form-check-label" for="confirmRestore">
              Entiendo que esto sobrescribira todos los datos actuales
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger" onclick="this.disabled=true; this.innerHTML='Restaurando...'; this.form.submit();">
            Restaurar Respaldo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<% if (success) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (error) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <strong>Informacion de Respaldos</strong>
  </div>
  <div class="card-body">
    <ul class="mb-0">
      <li>Los respaldos se almacenan como dumps de MongoDB comprimidos (archivos .gz)</li>
      <li>Descarga los respaldos regularmente y guardalos en un lugar seguro (Google Drive, Dropbox, etc.)</li>
      <li>Solo se mantienen los ultimos 10 respaldos en el servidor</li>
      <li>Para restaurar: <code>zcat backup-file.gz | docker exec -i testquest-mongo-1 mongorestore --archive --gzip --drop</code></li>
    </ul>
  </div>
</div>

<% if (backups.length === 0) { %>
  <div class="alert alert-warning">
    No se encontraron respaldos. Crea tu primer respaldo ahora!
  </div>
<% } else { %>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nombre de Archivo</th>
        <th>Tamano</th>
        <th>Creado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% backups.forEach(backup => { %>
        <tr>
          <td><code><%= backup.filename %></code></td>
          <td><%= backup.size %></td>
          <td><%= backup.created.toLocaleString() %></td>
          <td>
            <a href="/admin/backups/<%= backup.filename %>/download" class="btn btn-sm btn-primary">
              Descargar
            </a>
            <form method="POST" action="/admin/backups/<%= backup.filename %>/delete" class="d-inline" onsubmit="return confirm('Eliminar este respaldo?');">
              <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } %>
