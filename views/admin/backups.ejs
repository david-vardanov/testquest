<% layout('layouts/boilerplate') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Database Backups</h2>
  <div>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
      Upload & Restore
    </button>
    <form method="POST" action="/admin/backups" class="d-inline">
      <button type="submit" class="btn btn-success" onclick="this.disabled=true; this.innerHTML='Creating backup...'; this.form.submit();">
        Create New Backup
      </button>
    </form>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload & Restore Backup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/admin/backups/restore" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Warning:</strong> This will replace ALL current data with the backup data. This action cannot be undone.
          </div>
          <div class="mb-3">
            <label class="form-label">Select backup file (.gz)</label>
            <input type="file" name="backup" class="form-control" accept=".gz" required>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="confirmRestore" required>
            <label class="form-check-label" for="confirmRestore">
              I understand this will overwrite all current data
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger" onclick="this.disabled=true; this.innerHTML='Restoring...'; this.form.submit();">
            Restore Backup
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<% if (success) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (error) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <strong>Backup Information</strong>
  </div>
  <div class="card-body">
    <ul class="mb-0">
      <li>Backups are stored as compressed MongoDB dumps (.gz files)</li>
      <li>Download backups regularly and store them in a safe location (Google Drive, Dropbox, etc.)</li>
      <li>Only the last 10 backups are kept on the server</li>
      <li>To restore: <code>zcat backup-file.gz | docker exec -i testquest-mongo-1 mongorestore --archive --gzip --drop</code></li>
    </ul>
  </div>
</div>

<% if (backups.length === 0) { %>
  <div class="alert alert-warning">
    No backups found. Create your first backup now!
  </div>
<% } else { %>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Filename</th>
        <th>Size</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% backups.forEach(backup => { %>
        <tr>
          <td><code><%= backup.filename %></code></td>
          <td><%= backup.size %></td>
          <td><%= backup.created.toLocaleString() %></td>
          <td>
            <a href="/admin/backups/<%= backup.filename %>/download" class="btn btn-sm btn-primary">
              Download
            </a>
            <form method="POST" action="/admin/backups/<%= backup.filename %>/delete" class="d-inline" onsubmit="return confirm('Delete this backup?');">
              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
<% } %>
