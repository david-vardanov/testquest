<% layout('layouts/boilerplate') %>

<style>
  .step-checkbox {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
  }
  .step-checkbox:last-child {
    border-bottom: none;
  }
  .step-checkbox label {
    cursor: pointer;
    margin-left: 0.5rem;
  }
  .step-checkbox input:checked + label {
    text-decoration: line-through;
    color: #6c757d;
  }
  .checklist-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
  }
  .checklist-box h6 {
    margin-bottom: 0.75rem;
    color: #495057;
  }
  .practice-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    margin: -1rem -1rem 1rem -1rem;
  }
</style>

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/tester">Panel de Control</a></li>
    <li class="breadcrumb-item active">Flujo de Practica</li>
  </ol>
</nav>

<div class="tutorial-hint">
  <strong>Modo Practica:</strong> Este es un flujo de practica para ayudarte a aprender como funciona TestQuest.
  No se otorgaran puntos - solo sigue y aprende la interfaz!
</div>

<div class="card">
  <div class="practice-header">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><%= testCase.title %></h4>
      <span class="badge bg-light text-dark">Practica <%= currentStep + 1 %> de <%= totalSteps %></span>
    </div>
  </div>
  <div class="card-body">
    <p><strong>Descripcion:</strong> <%= testCase.description %></p>

    <%
      // Parse scenario steps
      const scenarioSteps = testCase.scenario.split('\n').map(s => s.trim()).filter(s => s.length > 0);
      const expectedSteps = testCase.expectedResult.split('\n').map(s => s.trim()).filter(s => s.length > 0);
      const totalCheckboxes = scenarioSteps.length + expectedSteps.length;
    %>

    <div class="checklist-box mb-3">
      <h6>Escenario / Pasos: <span class="badge bg-secondary" id="steps-counter">0/<%= scenarioSteps.length %></span></h6>
      <% scenarioSteps.forEach((step, idx) => { %>
        <div class="step-checkbox">
          <input type="checkbox" class="form-check-input step-check" id="step-<%= idx %>" data-type="step">
          <label for="step-<%= idx %>"><%= step %></label>
        </div>
      <% }) %>
    </div>

    <div class="checklist-box mb-4">
      <h6>Resultado Esperado: <span class="badge bg-secondary" id="expected-counter">0/<%= expectedSteps.length %></span></h6>
      <% expectedSteps.forEach((step, idx) => { %>
        <div class="step-checkbox">
          <input type="checkbox" class="form-check-input expected-check" id="expected-<%= idx %>" data-type="expected">
          <label for="expected-<%= idx %>"><%= step %></label>
        </div>
      <% }) %>
    </div>

    <hr>

    <form method="POST" action="/tester/practice-flow/submit" id="practice-form">
      <div class="mb-3">
        <label class="form-label"><strong>Resultado de la Prueba:</strong></label>
        <div class="tutorial-hint mb-2">
          <strong>Consejo:</strong>
          <% if (currentStep === 0) { %>
            Marca todas las casillas de arriba para desbloquear "Aprobado". En pruebas reales, solo seleccionas "Aprobado" despues de verificar que todos los pasos funcionan correctamente.
          <% } else if (currentStep === 1) { %>
            Selecciona "Fallido" para practicar reportar un error. Cuando encuentras un error real, esto te otorga +3 puntos extra!
          <% } else { %>
            Puedes seleccionar cualquiera - esto te ensena sobre capturas de pantalla y comentarios.
          <% } %>
        </div>
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input passed-radio" type="radio" name="status" id="status-passed" value="passed" disabled>
            <label class="form-check-label text-success" for="status-passed">Aprobado</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="status" id="status-failed" value="failed">
            <label class="form-check-label text-danger" for="status-failed">Fallido (+3 pts por encontrar error)</label>
          </div>
        </div>
        <div class="text-muted small mt-1" id="unlock-hint">
          Marca todos los pasos de arriba para desbloquear "Aprobado"
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Comentarios (+1 pt)</label>
        <div class="tutorial-hint mb-2">
          <strong>Consejo:</strong> Agregar comentarios detallados ayuda a los desarrolladores a entender los problemas. En pruebas reales, siempre describe lo que observaste!
        </div>
        <textarea name="feedback" class="form-control" rows="3" placeholder="Describe lo que observaste, problemas encontrados o sugerencias..."></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Captura de Pantalla (+1 pt)</label>
        <div class="tutorial-hint mb-2">
          <strong>Consejo:</strong> Las capturas de pantalla proporcionan prueba visual. Intenta subir cualquier imagen para ver como funciona!
        </div>
        <input type="file" name="screenshot" class="form-control" accept="image/*">
      </div>

      <div class="alert alert-secondary">
        <strong>Recordatorio de puntos (para pruebas reales):</strong>
        <ul class="mb-0">
          <li>Base: varia segun dificultad de la prueba</li>
          <li>Estado Fallido (error encontrado): +3 pts</li>
          <li>Comentarios: +1 pt</li>
          <li>Captura de Pantalla: +1 pt</li>
          <li>Bonus por comentarios utiles del admin: +1 pt</li>
          <li>Bonus por completar flujo: se otorga cuando todas las pruebas son aprobadas</li>
        </ul>
      </div>

      <button type="submit" class="btn btn-primary btn-lg">
        <%= currentStep < totalSteps - 1 ? 'Continuar a la Siguiente Practica' : 'Completar Practica' %>
      </button>
      <a href="/tester" class="btn btn-outline-secondary btn-lg ms-2">Salir de Practica</a>
    </form>
  </div>
</div>

<script>
  (function() {
    const totalSteps = <%= scenarioSteps.length %>;
    const totalExpected = <%= expectedSteps.length %>;
    const totalCheckboxes = totalSteps + totalExpected;

    const stepChecks = document.querySelectorAll('.step-check');
    const expectedChecks = document.querySelectorAll('.expected-check');
    const passedRadio = document.getElementById('status-passed');
    const failedRadio = document.getElementById('status-failed');
    const unlockHint = document.getElementById('unlock-hint');
    const stepsCounter = document.getElementById('steps-counter');
    const expectedCounter = document.getElementById('expected-counter');

    function updateState() {
      const checkedSteps = document.querySelectorAll('.step-check:checked').length;
      const checkedExpected = document.querySelectorAll('.expected-check:checked').length;
      const allChecked = (checkedSteps + checkedExpected) === totalCheckboxes;

      stepsCounter.textContent = checkedSteps + '/' + totalSteps;
      expectedCounter.textContent = checkedExpected + '/' + totalExpected;

      stepsCounter.className = 'badge ' + (checkedSteps === totalSteps ? 'bg-success' : 'bg-secondary');
      expectedCounter.className = 'badge ' + (checkedExpected === totalExpected ? 'bg-success' : 'bg-secondary');

      if (allChecked) {
        passedRadio.disabled = false;
        unlockHint.style.display = 'none';
      } else {
        passedRadio.disabled = true;
        if (passedRadio.checked) {
          passedRadio.checked = false;
        }
        unlockHint.style.display = 'block';
      }
    }

    stepChecks.forEach(cb => cb.addEventListener('change', updateState));
    expectedChecks.forEach(cb => cb.addEventListener('change', updateState));

    updateState();
  })();
</script>
