<% layout('layouts/boilerplate') %>

<style>
  .step-checkbox {
    padding: 0.5rem 0;
    border-bottom: 1px solid #eee;
  }
  .step-checkbox:last-child {
    border-bottom: none;
  }
  .step-checkbox label {
    cursor: pointer;
    margin-left: 0.5rem;
  }
  .step-checkbox input:checked + label {
    text-decoration: line-through;
    color: #6c757d;
  }
  .checklist-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
  }
  .checklist-box h6 {
    margin-bottom: 0.75rem;
    color: #495057;
  }
  .passed-radio:disabled + label {
    color: #adb5bd !important;
  }
  .unlock-hint {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
</style>

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/tester">Flujos</a></li>
    <li class="breadcrumb-item active"><%= flow.name %></li>
  </ol>
</nav>

<div class="card">
  <div class="card-header">
    <h4><%= testCase.title %></h4>
    <small class="text-muted">Progreso: <%= progress.completedTestCases.length + 1 %> de <%= flow.testCases.length %></small>
  </div>
  <div class="card-body">
    <p><strong>Descripcion:</strong> <%= testCase.description %></p>

    <%
      // Parse scenario steps (split by newlines, filter empty)
      const scenarioSteps = testCase.scenario.split('\n').map(s => s.trim()).filter(s => s.length > 0);
      // Parse expected results (split by newlines, filter empty)
      const expectedSteps = testCase.expectedResult.split('\n').map(s => s.trim()).filter(s => s.length > 0);
      const totalCheckboxes = scenarioSteps.length + expectedSteps.length;
    %>

    <div class="checklist-box mb-3">
      <h6>Escenario / Pasos: <span class="badge bg-secondary" id="steps-counter">0/<%= scenarioSteps.length %></span></h6>
      <% scenarioSteps.forEach((step, idx) => { %>
        <div class="step-checkbox">
          <input type="checkbox" class="form-check-input step-check" id="step-<%= idx %>" data-type="step">
          <label for="step-<%= idx %>"><%= step %></label>
        </div>
      <% }) %>
    </div>

    <div class="checklist-box mb-4">
      <h6>Resultado Esperado: <span class="badge bg-secondary" id="expected-counter">0/<%= expectedSteps.length %></span></h6>
      <% expectedSteps.forEach((step, idx) => { %>
        <div class="step-checkbox">
          <input type="checkbox" class="form-check-input expected-check" id="expected-<%= idx %>" data-type="expected">
          <label for="expected-<%= idx %>"><%= step %></label>
        </div>
      <% }) %>
    </div>

    <hr>

    <form method="POST" action="/tester/flow/<%= flow._id %>/submit/<%= testCase._id %>" enctype="multipart/form-data" id="test-form">
      <div class="mb-3">
        <label class="form-label"><strong>Resultado de la Prueba:</strong></label>
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input passed-radio" type="radio" name="status" id="status-passed" value="passed" disabled required>
            <label class="form-check-label text-success" for="status-passed">Aprobado</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="status" id="status-failed" value="failed" required>
            <label class="form-check-label text-danger" for="status-failed">Fallido (+3 pts por encontrar error)</label>
          </div>
        </div>
        <div class="unlock-hint" id="unlock-hint">
          Marca todos los pasos y resultados esperados para desbloquear "Aprobado"
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Comentarios (+1 pt)</label>
        <textarea name="feedback" class="form-control" rows="3" placeholder="Describe lo que observaste, problemas encontrados o sugerencias..."></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Captura de Pantalla (+1 pt)</label>
        <input type="file" name="screenshot" class="form-control" accept="image/*">
      </div>

      <div class="alert alert-info">
        <strong>Desglose de Puntos:</strong>
        <ul class="mb-0">
          <li>Base: 1 pt</li>
          <li>Estado Fallido (error encontrado): +3 pts</li>
          <li>Comentarios: +1 pt</li>
          <li>Captura de Pantalla: +1 pt</li>
        </ul>
      </div>

      <button type="submit" class="btn btn-primary btn-lg">Enviar Resultado</button>
    </form>
  </div>
</div>

<script>
  (function() {
    const totalSteps = <%= scenarioSteps.length %>;
    const totalExpected = <%= expectedSteps.length %>;
    const totalCheckboxes = totalSteps + totalExpected;

    const stepChecks = document.querySelectorAll('.step-check');
    const expectedChecks = document.querySelectorAll('.expected-check');
    const passedRadio = document.getElementById('status-passed');
    const failedRadio = document.getElementById('status-failed');
    const unlockHint = document.getElementById('unlock-hint');
    const stepsCounter = document.getElementById('steps-counter');
    const expectedCounter = document.getElementById('expected-counter');

    function updateState() {
      const checkedSteps = document.querySelectorAll('.step-check:checked').length;
      const checkedExpected = document.querySelectorAll('.expected-check:checked').length;
      const allChecked = (checkedSteps + checkedExpected) === totalCheckboxes;

      // Update counters
      stepsCounter.textContent = checkedSteps + '/' + totalSteps;
      expectedCounter.textContent = checkedExpected + '/' + totalExpected;

      // Update counter colors
      stepsCounter.className = 'badge ' + (checkedSteps === totalSteps ? 'bg-success' : 'bg-secondary');
      expectedCounter.className = 'badge ' + (checkedExpected === totalExpected ? 'bg-success' : 'bg-secondary');

      // Enable/disable passed radio
      if (allChecked) {
        passedRadio.disabled = false;
        unlockHint.style.display = 'none';
      } else {
        passedRadio.disabled = true;
        // If passed was selected and we uncheck, switch to nothing
        if (passedRadio.checked) {
          passedRadio.checked = false;
        }
        unlockHint.style.display = 'block';
      }
    }

    // Attach listeners
    stepChecks.forEach(cb => cb.addEventListener('change', updateState));
    expectedChecks.forEach(cb => cb.addEventListener('change', updateState));

    // Initial state
    updateState();
  })();
</script>
