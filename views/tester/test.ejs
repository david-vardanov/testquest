<% layout('layouts/boilerplate') %>

<%
  // Parse scenario steps and expected results
  const scenarioSteps = testCase.scenario.split('\n').map(s => s.trim()).filter(s => s.length > 0);
  const expectedSteps = testCase.expectedResult.split('\n').map(s => s.trim()).filter(s => s.length > 0);
  const totalCheckboxes = scenarioSteps.length + expectedSteps.length;
  const currentTestNum = progress.completedTestCases.length + 1;
  const totalTests = visibleTestCasesCount;
  const progressPercent = Math.round((progress.completedTestCases.length / totalTests) * 100);

  // Function to convert URLs to clickable links
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<>"']+)/g;
    return text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: underline;">$1</a>');
  }
%>

<style>
  .test-page {
    max-width: 900px;
    margin: 0 auto;
  }

  /* Header */
  .test-header {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .test-header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .back-link:hover {
    color: #667eea;
  }

  .test-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .test-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
  }

  .test-description {
    color: #64748b;
    font-size: 0.95rem;
    margin: 0 0 1.25rem 0;
    line-height: 1.5;
  }

  .test-title a,
  .test-description a {
    color: #667eea;
    text-decoration: underline;
  }

  .test-title a:hover,
  .test-description a:hover {
    color: #764ba2;
  }

  .progress-bar-container {
    background: #e2e8f0;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.5rem;
  }

  /* Two Column Layout */
  .test-content {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 1.5rem;
    align-items: start;
  }

  /* Checklist Section */
  .checklist-section {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .checklist-box {
    margin-bottom: 1.5rem;
  }

  .checklist-box:last-child {
    margin-bottom: 0;
  }

  .checklist-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f1f5f9;
  }

  .checklist-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
  }

  .checklist-title .icon {
    font-size: 1.1rem;
  }

  .checklist-counter {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.625rem;
    border-radius: 12px;
    transition: all 0.2s;
  }

  .checklist-counter.pending {
    background: #f1f5f9;
    color: #64748b;
  }

  .checklist-counter.complete {
    background: #dcfce7;
    color: #16a34a;
  }

  .step-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: background 0.2s;
  }

  .step-item:last-child {
    margin-bottom: 0;
  }

  .step-item:hover {
    background: #f8fafc;
  }

  .step-item.checked {
    background: #f0fdf4;
  }

  .step-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
    accent-color: #667eea;
  }

  .step-item label {
    flex: 1;
    cursor: pointer;
    font-size: 0.9rem;
    color: #334155;
    line-height: 1.5;
    transition: color 0.2s;
  }

  .step-item.checked label {
    color: #16a34a;
    text-decoration: line-through;
  }

  .step-item label a {
    color: #667eea;
    text-decoration: underline;
  }

  .step-item label a:hover {
    color: #764ba2;
  }

  .step-item.checked label a {
    color: #16a34a;
  }

  /* Form Section */
  .form-section {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    position: sticky;
    top: 20px;
  }

  .form-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 1.25rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f1f5f9;
  }

  /* Status Selection */
  .status-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }

  .status-option {
    position: relative;
  }

  .status-option input {
    position: absolute;
    opacity: 0;
  }

  .status-option label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .status-option input:checked + label {
    border-color: currentColor;
    background: currentColor;
  }

  .status-option.passed label {
    color: #16a34a;
  }

  .status-option.passed input:checked + label {
    background: #dcfce7;
    border-color: #16a34a;
    color: #16a34a;
  }

  .status-option.failed label {
    color: #dc2626;
  }

  .status-option.failed input:checked + label {
    background: #fee2e2;
    border-color: #dc2626;
    color: #dc2626;
  }

  .status-option input:disabled + label {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .status-icon {
    font-size: 1.25rem;
  }

  .status-text {
    flex: 1;
  }

  .status-text strong {
    display: block;
    font-size: 0.9rem;
  }

  .status-text span {
    font-size: 0.75rem;
    opacity: 0.8;
  }

  .unlock-hint {
    background: #fef3c7;
    color: #92400e;
    font-size: 0.8rem;
    padding: 0.625rem 0.875rem;
    border-radius: 8px;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .unlock-hint.hidden {
    display: none;
  }

  /* Form Fields */
  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .form-label .bonus {
    font-size: 0.75rem;
    color: #16a34a;
    font-weight: 500;
  }

  .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem;
    font-size: 0.9rem;
    transition: border-color 0.2s;
  }

  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
  }

  textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }

  /* Points Info */
  .points-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.25rem;
    color: white;
  }

  .points-info-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
    margin-bottom: 0.75rem;
  }

  .points-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .point-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 0.5rem;
    border-radius: 8px;
    text-align: center;
  }

  .point-item .value {
    font-size: 1rem;
    font-weight: 700;
  }

  .point-item .label {
    font-size: 0.65rem;
    opacity: 0.9;
  }

  /* Submit Button */
  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  /* Mobile */
  @media (max-width: 900px) {
    .test-content {
      grid-template-columns: 1fr;
    }

    .form-section {
      position: static;
    }
  }

  @media (max-width: 767.98px) {
    .test-header {
      padding: 1.25rem;
      border-radius: 12px;
    }

    .test-title {
      font-size: 1.25rem;
    }

    .test-header-top {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .checklist-section,
    .form-section {
      padding: 1.25rem;
      border-radius: 12px;
    }

    .step-item {
      padding: 0.875rem;
    }

    .step-item input[type="checkbox"] {
      width: 22px;
      height: 22px;
    }

    .step-item label {
      font-size: 1rem;
    }

    .status-option label {
      padding: 1rem;
    }

    .points-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="test-page">
  <!-- Header -->
  <div class="test-header">
    <div class="test-header-top">
      <a href="/tester" class="back-link">
        &#8592; <%= flow.name %>
      </a>
      <span class="test-badge">Prueba <%= currentTestNum %> de <%= totalTests %></span>
    </div>
    <h1 class="test-title"><%- linkify(testCase.title || '') %></h1>
    <p class="test-description"><%- linkify(testCase.description || '') %></p>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" style="width: <%= progressPercent %>%"></div>
    </div>
    <div class="progress-label">
      <span><%= progressPercent %>% completado</span>
      <span><%= progress.completedTestCases.length %> de <%= totalTests %> pruebas</span>
    </div>
  </div>

  <div class="test-content">
    <!-- Checklists -->
    <div class="checklist-section">
      <div class="checklist-box">
        <div class="checklist-header">
          <h3 class="checklist-title">
            <span class="icon">&#128203;</span>
            Escenario / Pasos
          </h3>
          <span class="checklist-counter pending" id="steps-counter">0/<%= scenarioSteps.length %></span>
        </div>
        <% scenarioSteps.forEach((step, idx) => { %>
          <div class="step-item" id="step-item-<%= idx %>">
            <input type="checkbox" class="step-check" id="step-<%= idx %>" data-type="step">
            <label for="step-<%= idx %>"><%- linkify(step) %></label>
          </div>
        <% }) %>
      </div>

      <div class="checklist-box">
        <div class="checklist-header">
          <h3 class="checklist-title">
            <span class="icon">&#9989;</span>
            Resultado Esperado
          </h3>
          <span class="checklist-counter pending" id="expected-counter">0/<%= expectedSteps.length %></span>
        </div>
        <% expectedSteps.forEach((step, idx) => { %>
          <div class="step-item" id="expected-item-<%= idx %>">
            <input type="checkbox" class="expected-check" id="expected-<%= idx %>" data-type="expected">
            <label for="expected-<%= idx %>"><%- linkify(step) %></label>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Form -->
    <div class="form-section">
      <h2 class="form-section-title">Enviar Resultado</h2>

      <form method="POST" action="/tester/flow/<%= flow._id %>/submit/<%= testCase._id %>" enctype="multipart/form-data" id="test-form">
        <!-- Status -->
        <div class="status-options">
          <div class="status-option passed">
            <input type="radio" name="status" id="status-passed" value="passed" class="passed-radio" disabled required>
            <label for="status-passed">
              <span class="status-icon">&#9989;</span>
              <span class="status-text">
                <strong>Aprobado</strong>
                <span>Todo funciona correctamente</span>
              </span>
            </label>
          </div>
          <div class="status-option failed">
            <input type="radio" name="status" id="status-failed" value="failed" required>
            <label for="status-failed">
              <span class="status-icon">&#128680;</span>
              <span class="status-text">
                <strong>Fallido</strong>
                <span>+3 pts por encontrar error</span>
              </span>
            </label>
          </div>
        </div>

        <div class="unlock-hint" id="unlock-hint">
          &#128274; Marca todos los pasos para desbloquear "Aprobado"
        </div>

        <!-- Feedback -->
        <div class="form-group">
          <label class="form-label">
            Comentarios
            <span class="bonus">+1 pt</span>
          </label>
          <textarea name="feedback" class="form-control" placeholder="Describe lo que observaste, problemas o sugerencias..."></textarea>
        </div>

        <!-- Screenshot -->
        <div class="form-group">
          <label class="form-label">
            Captura de Pantalla
            <span class="bonus">+1 pt</span>
          </label>
          <input type="file" name="screenshot" class="form-control" accept="image/*">
        </div>

        <!-- Points Info -->
        <div class="points-info">
          <div class="points-info-title">Puntos Disponibles</div>
          <div class="points-grid">
            <div class="point-item">
              <div class="value"><%= testCase.basePoints || 1 %></div>
              <div class="label">Base</div>
            </div>
            <div class="point-item">
              <div class="value">+3</div>
              <div class="label">Error</div>
            </div>
            <div class="point-item">
              <div class="value">+1</div>
              <div class="label">Comentario</div>
            </div>
            <div class="point-item">
              <div class="value">+1</div>
              <div class="label">Captura</div>
            </div>
          </div>
        </div>

        <button type="submit" class="submit-btn">
          Enviar Resultado
          <span>&#8594;</span>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  (function() {
    const totalSteps = <%= scenarioSteps.length %>;
    const totalExpected = <%= expectedSteps.length %>;
    const totalCheckboxes = totalSteps + totalExpected;

    const stepChecks = document.querySelectorAll('.step-check');
    const expectedChecks = document.querySelectorAll('.expected-check');
    const passedRadio = document.getElementById('status-passed');
    const unlockHint = document.getElementById('unlock-hint');
    const stepsCounter = document.getElementById('steps-counter');
    const expectedCounter = document.getElementById('expected-counter');

    function updateState() {
      const checkedSteps = document.querySelectorAll('.step-check:checked').length;
      const checkedExpected = document.querySelectorAll('.expected-check:checked').length;
      const allChecked = (checkedSteps + checkedExpected) === totalCheckboxes;

      // Update counters
      stepsCounter.textContent = checkedSteps + '/' + totalSteps;
      expectedCounter.textContent = checkedExpected + '/' + totalExpected;

      // Update counter styles
      stepsCounter.className = 'checklist-counter ' + (checkedSteps === totalSteps ? 'complete' : 'pending');
      expectedCounter.className = 'checklist-counter ' + (checkedExpected === totalExpected ? 'complete' : 'pending');

      // Update step item styles
      stepChecks.forEach((cb, idx) => {
        const item = document.getElementById('step-item-' + idx);
        if (item) item.classList.toggle('checked', cb.checked);
      });
      expectedChecks.forEach((cb, idx) => {
        const item = document.getElementById('expected-item-' + idx);
        if (item) item.classList.toggle('checked', cb.checked);
      });

      // Enable/disable passed radio
      if (allChecked) {
        passedRadio.disabled = false;
        unlockHint.classList.add('hidden');
      } else {
        passedRadio.disabled = true;
        if (passedRadio.checked) {
          passedRadio.checked = false;
        }
        unlockHint.classList.remove('hidden');
      }
    }

    stepChecks.forEach(cb => cb.addEventListener('change', updateState));
    expectedChecks.forEach(cb => cb.addEventListener('change', updateState));

    updateState();
  })();
</script>
